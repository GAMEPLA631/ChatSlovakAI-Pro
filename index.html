<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatSlovak AI Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* Základné štýly tela stránky a pozadia */
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://images.deepai.org/art-image/31cd000b7f3148918f85f76a1b8604f7/ai-495f1e.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #E2E8F0;
            margin: 0;
            padding: 0;
        }

        /* Kontajner aplikácie s rozostreným pozadím */
        .app-container {
            position: relative;
            z-index: 10;
        }
        .app-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            border-radius: 1.5rem;
            z-index: -1;
        }

        /* Okno správ */
        .message-container {
            max-height: 70vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .message-container::-webkit-scrollbar {
            width: 8px;
        }
        .message-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .message-container::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        
        /* Rôzne štýly správ */
        .user-message {
            background-color: rgba(67, 56, 202, 0.7);
            color: white;
            border-bottom-right-radius: 0;
        }
        .ai-message {
            background-color: rgba(31, 41, 55, 0.7);
            color: #E2E8F0;
            border-bottom-left-radius: 0;
        }

        /* Indikátor načítania (bodky) */
        .dot-flashing {
            position: relative;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #9880ff;
            color: #9880ff;
            animation: dot-flashing 1s infinite linear alternate;
            animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #9880ff;
            color: #9880ff;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #9880ff;
            color: #9880ff;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 1s;
        }
        @keyframes dot-flashing {
            0% { background-color: #9880ff; }
            50%, 100% { background-color: #eee; }
        }

        /* Prepínač */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4b5563; /* Sivá farba pre vypnutý stav */
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            transform: translateX(0);
        }
        input:checked + .slider {
            background-color: #9880ff; /* Fialová farba pre zapnutý stav */
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* Animácie pre modálne okná */
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.5s ease-out;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
    <!-- Kontajner pre modálne okno -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div id="modal-content" class="bg-gray-800 p-6 rounded-xl text-center shadow-lg w-full max-w-sm animate-fade-in-up">
            <h3 id="modal-title" class="text-xl font-bold text-white mb-2"></h3>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <button id="modal-close-button" class="w-full p-3 bg-purple-700 hover:bg-purple-800 text-white font-bold rounded-full transition-all duration-200">OK</button>
        </div>
    </div>

    <main class="w-full max-w-3xl flex flex-col h-[90vh] app-container rounded-3xl p-6 shadow-2xl">
        
        <!-- Hlavička aplikácie -->
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-white tracking-wide">ChatSlovak AI Pro</h1>
            <p class="text-sm text-gray-300 mt-2" id="subscription-status"></p>
            <!-- Nový element pre zobrazenie počtu správ -->
            <p class="text-sm font-semibold text-purple-400 mt-1" id="message-limit-status"></p>
        </header>

        <!-- Platobné rozhranie (skryté predvolene) -->
        <div id="payment-view" class="flex-grow flex flex-col items-center justify-center text-center p-8 hidden">
            <h2 class="text-3xl font-bold text-white mb-4">Predplatné vypršalo</h2>
            <p class="text-lg text-gray-300 mb-6">Pre ďalšie používanie je potrebné zaplatiť poplatok.</p>
            <div class="bg-gray-800/70 p-6 rounded-xl w-full max-w-sm flex flex-col items-center shadow-lg">
                <p id="current-price-display" class="text-4xl font-extrabold text-purple-400 mb-4">1.00 €</p>
                <p class="text-sm text-gray-400 mb-6">za 30 dní prístupu</p>
                
                <!-- Formulár pre platbu kartou (simulácia) -->
                <div class="w-full space-y-4 mb-4">
                    <h3 class="text-lg font-semibold text-gray-200">Platba kartou</h3>
                    <input type="text" id="card-number" placeholder="Číslo karty" class="w-full p-3 bg-gray-900/60 text-white rounded-lg border border-gray-700/50 focus:outline-none focus:ring-1 focus:ring-purple-600 transition-all duration-200">
                    <div class="flex space-x-2">
                        <input type="text" id="expiry-date" placeholder="MM/YY" class="w-1/2 p-3 bg-gray-900/60 text-white rounded-lg border border-gray-700/50 focus:outline-none focus:ring-1 focus:ring-purple-600 transition-all duration-200">
                        <input type="text" id="cvv-code" placeholder="CVV" class="w-1/2 p-3 bg-gray-900/60 text-white rounded-lg border border-gray-700/50 focus:outline-none focus:ring-1 focus:ring-purple-600 transition-all duration-200">
                    </div>
                </div>

                <!-- Formulár pre PaySafeCard (simulácia) -->
                <div class="w-full space-y-4 mb-6">
                    <h3 class="text-lg font-semibold text-gray-200">Alebo PaySafeCard</h3>
                    <input type="text" id="paysafe-code" placeholder="16-miestny kód PaySafeCard" class="w-full p-3 bg-gray-900/60 text-white rounded-lg border border-gray-700/50 focus:outline-none focus:ring-1 focus:ring-purple-600 transition-all duration-200">
                </div>
                
                <p id="payment-error" class="text-red-400 text-sm mb-4 hidden">Prosím, vyplňte aspoň jeden platobný údaj.</p>

                <button id="pay-button" class="w-full p-4 bg-purple-700 hover:bg-purple-800 text-white font-bold rounded-full shadow-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-purple-600 focus:ring-offset-2 focus:ring-offset-gray-900">
                    Zaplatiť teraz
                </button>
            </div>
        </div>

        <!-- Chatovacie rozhranie -->
        <div id="chat-view" class="flex flex-col flex-grow hidden">
            <!-- Okno chatu pre zobrazenie správ -->
            <div id="chat-window" class="message-container flex-grow mb-4 p-4 space-y-4 rounded-xl">
                <!-- Správy sa budú vkladať sem cez JavaScript -->
            </div>

            <!-- Vstupná oblasť pre písanie správ a prepínač -->
            <div class="flex flex-col space-y-2 mt-auto">
                <p id="cooldown-status" class="text-sm font-bold text-red-400 text-center hidden"></p>
                <div class="flex items-center space-x-3">
                    <label class="toggle-switch flex-shrink-0">
                        <input type="checkbox" id="tts-api-toggle" checked>
                        <span class="slider"></span>
                    </label>
                    <input type="text" id="user-input" placeholder="Napíšte svoju správu..." class="flex-grow p-4 bg-gray-900/60 text-white placeholder-gray-400 rounded-full border border-gray-700/50 shadow-lg focus:outline-none focus:ring-2 focus:ring-purple-600 transition-all duration-200">
                    <button id="send-button" class="p-4 bg-purple-700 hover:bg-purple-800 text-white rounded-full shadow-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-purple-600 focus:ring-offset-2 focus:ring-offset-gray-900">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // DOM prvky
        const paymentView = document.getElementById('payment-view');
        const chatView = document.getElementById('chat-view');
        const payButton = document.getElementById('pay-button');
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const ttsApiToggle = document.getElementById('tts-api-toggle');
        const subscriptionStatus = document.getElementById('subscription-status');
        const cardNumberInput = document.getElementById('card-number');
        const paysafeCodeInput = document.getElementById('paysafe-code');
        const paymentError = document.getElementById('payment-error');
        const currentPriceDisplay = document.getElementById('current-price-display');
        const messageLimitStatus = document.getElementById('message-limit-status');
        const cooldownStatus = document.getElementById('cooldown-status'); // Nový element

        // Modálne prvky
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseButton = document.getElementById('modal-close-button');

        // Stavové premenné
        let chatHistory = [];
        // API kľúč pre Gemini. V prostredí Canvas sa nastaví automaticky.
        const geminiApiKey = "AIzaSyA7UeU1kIC_0VF5HNCeEhrBkPFoeoIiC4o";
        let audioInstance = null;
        const SUBSCRIPTION_KEY = 'premium-chat-subscription';

        // --- KONŠTANTY PRE LIMITY SPRÁV (NOVÉ A UPRAVENÉ) ---
        const MAX_MESSAGES_PAID = 100; // Maximálny počet správ pre platených používateľov
        const MAX_MESSAGES_FREE = 5; // Maximálny počet správ pre neregistrovaných (obmedzená verzia)
        // Kľúče pre lokálne úložisko pre počet správ
        const MESSAGE_COUNT_KEY_FREE = 'chat-message-count-free';
        const MESSAGE_COUNT_KEY_PAID = 'chat-message-count-paid';
        // --- KONIEC NOVÝCH KONŠTÁNT ---
        
        // --- NOVÉ PREMENNÉ PRE NÁHODNÝ ČASOVÝ LIMIT (COOLDOWN) ---
        const MESSAGES_BEFORE_COOLDOWN = 5; // Počet správ pred spustením cool-downu
        let messagesSinceCooldown = 0; // Počet správ od posledného cool-downu
        let isCooldownActive = false;
        let cooldownEndTime = null;
        let cooldownInterval = null; // Na uloženie intervalu pre aktualizáciu časovača
        // --- KONIEC NOVÝCH PREMENNÝCH ---

        // --- Funkcie pre modálne okná namiesto alert() ---
        /**
        * Zobrazí modálne okno s daným titulom a správou.
        * @param {string} title Titulok modálneho okna.
        * @param {string} message Správa zobrazená v modálnom okne.
        * @param {function} onCloseCallback Funkcia, ktorá sa má vykonať po zatvorení modálneho okna.
        */
        function showModal(title, message, onCloseCallback = null) {
            modalTitle.innerText = title;
            modalMessage.innerText = message;
            modalBackdrop.classList.remove('hidden');

            const handleClose = () => {
                modalBackdrop.classList.add('hidden');
                modalCloseButton.removeEventListener('click', handleClose);
                if (onCloseCallback) {
                    onCloseCallback();
                }
            };
            modalCloseButton.addEventListener('click', handleClose);
        }

        // Zobrazí chybovú správu na obrazovke
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'absolute bottom-20 left-1/2 -translate-x-1/2 p-4 bg-red-600 text-white rounded-lg shadow-xl animate-fade-in-up transition-opacity duration-300 z-50';
            errorDiv.innerText = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => {
                errorDiv.classList.add('opacity-0');
                errorDiv.addEventListener('transitionend', () => errorDiv.remove());
            }, 3000);
        }

        // --- Funkcie pre lokálne úložisko ---
        
        /**
        * Uloží dáta do lokálneho úložiska.
        * @param {string} key Kľúč na uloženie.
        * @param {any} data Dáta na uloženie.
        */
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error("Chyba pri ukladaní do lokálneho úložiska:", error);
            }
        }

        /**
        * Načíta dáta z lokálneho úložiska.
        * @param {string} key Kľúč na načítanie.
        * @returns {any | null} Načítané dáta alebo null.
        */
        function loadFromLocalStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error("Chyba pri načítavaní z lokálneho úložiska:", error);
                return null;
            }
        }
        
        // --- Funkcie pre správu predplatného a dynamické ceny ---

        /**
        * Skontroluje stav predplatného a zobrazí príslušné rozhranie.
        */
        function checkSubscription() {
            const subscriptionData = loadFromLocalStorage(SUBSCRIPTION_KEY);
            const now = new Date();
            
            if (subscriptionData && new Date(subscriptionData.expiryDate) > now) {
                // Predplatné je aktívne
                chatView.classList.remove('hidden');
                paymentView.classList.add('hidden');
                
                const expiryDate = new Date(subscriptionData.expiryDate);
                const daysRemaining = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                subscriptionStatus.innerText = `Predplatné je aktívne. Zostáva ${daysRemaining} dní.`;

                // Zobrazenie limitu pre platenú verziu (100 správ)
                let paidMessageCount = loadFromLocalStorage(MESSAGE_COUNT_KEY_PAID) || 0;
                messageLimitStatus.innerText = `Platená verzia: ${Math.max(0, MAX_MESSAGES_PAID - paidMessageCount)} správ zostáva.`;
                
                cooldownStatus.classList.add('hidden'); // Skrytie stavu cooldown pre premium používateľov

                // Vymaže sa existujúca história a pridá sa nová úvodná správa
                chatHistory = [];
                chatWindow.innerHTML = '';
                appendAiMessage("Ahoj! Poďme chatovať. Generovanie hlasu je zapnuté.", ttsApiToggle.checked, false);
                chatWindow.scrollTop = chatWindow.scrollHeight;
                
            } else {
                // Predplatné vypršalo alebo neexistuje
                chatView.classList.add('hidden');
                paymentView.classList.remove('hidden');

                // Vypočítanie novej ceny
                const lastPaidPrice = subscriptionData ? subscriptionData.lastPaidPrice : 0;
                let newPrice = parseFloat(lastPaidPrice) + 1.00;
                
                // Kontrola maximálnej ceny a reset
                const maxPrice = 1500.00;
                if (newPrice > maxPrice) {
                    newPrice = 1.00;
                }

                currentPriceDisplay.innerText = `${newPrice.toFixed(2)} €`;
                subscriptionStatus.innerText = `Predplatné vypršalo.`;

                // Zobrazenie limitu pre skúšobnú verziu (5 správ)
                let freeMessageCount = loadFromLocalStorage(MESSAGE_COUNT_KEY_FREE) || 0;
                messageLimitStatus.innerText = `Skúšobná verzia: ${Math.max(0, MAX_MESSAGES_FREE - freeMessageCount)} správ zostáva.`;

                // Vymaže sa existujúca história a pridá sa nová úvodná správa
                chatHistory = [];
                chatWindow.innerHTML = '';
                appendAiMessage(`Ahoj! Vyskúšajte ChatSlovak AI Pro zadarmo. Máte k dispozícii ${MAX_MESSAGES_FREE} správ.`, ttsApiToggle.checked, false);
            }
        }
        
        /**
        * Simuluje platobný proces.
        */
        function simulatePayment() {
            const cardNumber = cardNumberInput.value.trim();
            const paysafeCode = paysafeCodeInput.value.trim();

            if (cardNumber === '' && paysafeCode === '') {
                paymentError.classList.remove('hidden');
                return;
            }
            
            paymentError.classList.add('hidden');
            
            // SIMULÁCIA: V reálnej aplikácii by sa tu volala platobná brána.
            // My len vytvoríme predplatné v lokálnom úložisku s novou cenou.
            const now = new Date();
            const expiryDate = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000); // 30 dní odteraz
            const currentPrice = parseFloat(currentPriceDisplay.innerText.replace(' €', ''));

            const subscriptionData = {
                expiryDate: expiryDate.toISOString(),
                lastPaidPrice: currentPrice
            };
            
            saveToLocalStorage(SUBSCRIPTION_KEY, subscriptionData);
            
            // Po úspešnej platbe resetujeme počítadlá správ pre obe verzie
            saveToLocalStorage(MESSAGE_COUNT_KEY_FREE, 0);
            saveToLocalStorage(MESSAGE_COUNT_KEY_PAID, 0);

            // Nahradenie alert() vlastným modálnym oknom
            showModal(
                "Platba úspešná",
                `Platba za ${currentPrice.toFixed(2)} € bola úspešne spracovaná! Vaše predplatné bolo aktivované na 30 dní.`,
                checkSubscription // Po zatvorení modálneho okna sa skontroluje predplatné
            );
        }
        
        // --- NOVÁ FUNKCIA: Správa cool-downu ---
        /**
        * Spustí cool-down (časový limit) na posielanie správ.
        */
        function startCooldown() {
            // Náhodný čas od 1 do 5 minút
            const randomTimeInMinutes = Math.floor(Math.random() * 5) + 1;
            const cooldownDuration = randomTimeInMinutes * 60 * 1000;
            cooldownEndTime = new Date(Date.now() + cooldownDuration);
            isCooldownActive = true;
            messagesSinceCooldown = 0; // Resetuje počítadlo správ

            userInput.disabled = true;
            sendButton.disabled = true;
            userInput.placeholder = "Prebieha časový limit...";
            cooldownStatus.classList.remove('hidden');

            // Aktualizuje časovač každú sekundu
            if (cooldownInterval) clearInterval(cooldownInterval);
            cooldownInterval = setInterval(updateCooldownTimer, 1000);

            showModal("Časový limit", `Dosiahli ste limit správ pre túto reláciu. Skúste to znova o ${randomTimeInMinutes} minút.`, () => {
                // Po zatvorení modálu sa nič nedeje, časovač beží na pozadí
            });
        }
        
        /**
        * Aktualizuje zobrazenie zostávajúceho času do konca cool-downu.
        */
        function updateCooldownTimer() {
            const now = new Date();
            if (cooldownEndTime > now) {
                const remainingTime = cooldownEndTime - now;
                const minutes = Math.floor(remainingTime / 60000);
                const seconds = Math.floor((remainingTime % 60000) / 1000);
                cooldownStatus.innerText = `Časový limit: Zostáva ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            } else {
                // Časový limit vypršal
                isCooldownActive = false;
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.placeholder = "Napíšte svoju správu...";
                cooldownStatus.classList.add('hidden');
                clearInterval(cooldownInterval);
                cooldownInterval = null;
                showModal("Časový limit vypršal", "Môžete pokračovať v chatovaní.");
            }
        }

        // --- Pomocné funkcie pre UI a API volania ---
        
        async function makeApiCall(apiUrl, payload, errorContext) {
            let retryCount = 0;
            const maxRetries = 3;

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        return response;
                    } else if (response.status === 429) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        console.warn(`API požiadavka zlyhala (${response.status}), opakujem o ${delay}ms...`);
                        await new Promise(res => setTimeout(res, delay));
                        retryCount++;
                    } else {
                        const errorData = await response.json();
                        throw new Error(`Volanie API pre ${errorContext} zlyhalo so stavom: ${response.status}. Správa: ${JSON.stringify(errorData)}`);
                    }
                } catch (error) {
                    if (retryCount >= maxRetries - 1) {
                        throw new Error(`Volanie API pre ${errorContext} zlyhalo po opakovaných pokusoch. Pôvodná chyba: ${error.message}`);
                    }
                    console.error(`Chyba siete pri volaní API pre ${errorContext}:`, error);
                    const delay = Math.pow(2, retryCount) * 1000;
                    console.warn(`Chyba siete, opakujem o ${delay}ms...`);
                    await new Promise(res => setTimeout(res, delay));
                    retryCount++;
                }
            }
            throw new Error(`Volanie API pre ${errorContext} zlyhalo po opakovaných pokusoch.`);
        }

        /**
        * Konvertuje base64 reťazec na ArrayBuffer.
        * @param {string} base64 Base64 zakódované dáta.
        * @returns {ArrayBuffer} Dekódované dáta v ArrayBuffer.
        */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
        * Konvertuje PCM dáta na WAV Blob.
        * @param {ArrayBuffer} pcmData RAW PCM audio dáta.
        * @param {number} sampleRate Vzorkovacia frekvencia zvuku.
        * @returns {Blob} Objekty Blob s hlavičkou WAV.
        */
        function pcmToWav(pcmData, sampleRate) {
            const pcm16 = new Int16Array(pcmData);
            const buffer = new ArrayBuffer(44 + pcm16.byteLength);
            const view = new DataView(buffer);
            let offset = 0;

            const writeString = (str) => {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset++, str.charCodeAt(i));
                }
            };

            writeString('RIFF');
            view.setUint32(offset, 36 + pcm16.byteLength, true); offset += 4;
            writeString('WAVE');
            writeString('fmt ');
            view.setUint32(offset, 16, true); offset += 4;
            view.setUint16(offset, 1, true); offset += 2; // AudioFormat: 1 = PCM
            view.setUint16(offset, 1, true); offset += 2; // NumChannels: 1 = Mono
            view.setUint32(offset, sampleRate, true); offset += 4; // SampleRate
            view.setUint32(offset, sampleRate * 2, true); offset += 4; // ByteRate (SampleRate * NumChannels * BitsPerSample/8)
            view.setUint16(offset, 2, true); offset += 2; // BlockAlign (NumChannels * BitsPerSample/8)
            view.setUint16(offset, 16, true); offset += 2; // BitsPerSample
            writeString('data');
            view.setUint32(offset, pcm16.byteLength, true); offset += 4;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }
            return new Blob([view], { type: 'audio/wav' });
        }
        
        /**
        * Volá API Gemini na generovanie hlasu z textu.
        * @param {string} text Text, ktorý sa má prečítať.
        * @returns {Promise<string|null>} URL objektu s audio dátami alebo null pri chybe.
        */
        async function speakWithGemini(text) {
            const prompt = `Hovorte veselým a priateľským hlasom v slovenčine: ${text}`;
            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Puck" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            const modelName = "gemini-2.5-flash-preview-tts";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${geminiApiKey}`;
            
            try {
                const response = await makeApiCall(apiUrl, payload, "generovanie hlasu cez Gemini");
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    const pcmData = base64ToArrayBuffer(audioData);
                    const wavBlob = pcmToWav(pcmData, sampleRate);
                    return URL.createObjectURL(wavBlob);
                } else {
                    throw new Error("Neplatná zvuková odpoveď od Gemini API.");
                }
            } catch (error) {
                console.error("Chyba pri generovaní hlasu Gemini:", error);
                showError(`Chyba API Gemini: ${error.message}`);
                return null;
            }
        }
        
        /**
        * Prehrá zvuk z daného textu, ak je prepínač zapnutý.
        * Ak už nejaký zvuk hrá, zastaví ho.
        * @param {string} text Text, ktorý sa má prečítať.
        */
        async function playAudio(text) {
            if (!ttsApiToggle.checked) {
                return;
            }

            if (audioInstance) {
                audioInstance.pause();
                audioInstance.currentTime = 0;
            }

            const audioUrl = await speakWithGemini(text);
            
            if (audioUrl) {
                const audio = new Audio();
                audio.src = audioUrl;
                audioInstance = audio;
                
                try {
                    await audio.play();
                } catch (playError) {
                    console.log("Automatické prehrávanie bolo zablokované.");
                }
            }
        }

        function appendUserMessage(message, shouldSave = true) {
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'flex justify-end';
            userMessageDiv.innerHTML = `
                <div class="max-w-[80%] bg-purple-700/70 text-white p-3 rounded-2xl rounded-br-none shadow-md">
                    <p>${message}</p>
                </div>
            `;
            chatWindow.appendChild(userMessageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            if (shouldSave) {
                chatHistory.push({ role: "user", parts: [{ text: message }] });
            }
        }

        function appendAiMessage(message, shouldPlayAudio = true, shouldSave = true) {
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.className = 'flex items-start my-4';
            
            const messageBubble = document.createElement('div');
            messageBubble.className = 'max-w-[80%] bg-gray-800/70 text-gray-200 p-3 rounded-2xl rounded-bl-none shadow-md whitespace-pre-wrap';
            messageBubble.innerHTML = `<p>${message}</p>`;

            aiMessageDiv.innerHTML = `
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-500 flex items-center justify-center mr-3">
                    <i class="fa-solid fa-robot text-white"></i>
                </div>
            `;
            aiMessageDiv.appendChild(messageBubble);
            
            chatWindow.appendChild(aiMessageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            if (shouldPlayAudio && ttsApiToggle.checked) {
                playAudio(message);
            }

            if (shouldSave) {
                chatHistory.push({ role: "model", parts: [{ text: message }] });
            }
        }
        
        // Funkcia na zobrazenie indikátora načítania
        function showLoadingIndicator() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.className = 'flex items-center my-4';
            loadingDiv.innerHTML = `
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-500 flex items-center justify-center mr-3">
                    <i class="fa-solid fa-robot text-white"></i>
                </div>
                <div class="p-3 bg-gray-800/70 rounded-2xl rounded-bl-none shadow-md">
                    <div class="dot-flashing"></div>
                </div>
            `;
            chatWindow.appendChild(loadingDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Funkcia na skrytie indikátora načítania
        function hideLoadingIndicator() {
            const loadingDiv = document.getElementById('loading-indicator');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        /**
         * Volá API Gemini na generovanie textu.
         * @param {string} prompt Text od používateľa.
         * @returns {Promise<string>} Generovaný text.
         */
        async function generateText(prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;
            let payload = { contents: [...chatHistory, { role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await makeApiCall(apiUrl, payload, "generovanie textu cez Gemini");
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("Neplatná textová odpoveď od Gemini API.");
                }
            } catch (error) {
                console.error("Chyba pri generovaní textu Gemini:", error);
                throw error;
            }
        }

        /**
         * Hlavná funkcia na odoslanie správy.
         */
        async function sendMessage() {
            if (isCooldownActive) {
                showModal("Časový limit", "Musíte počkať, kým neskončí časový limit.");
                return;
            }

            const message = userInput.value.trim();
            if (message === '') return;
            
            // Kontrola limitu správ
            const subscriptionData = loadFromLocalStorage(SUBSCRIPTION_KEY);
            const isPremium = subscriptionData && new Date(subscriptionData.expiryDate) > new Date();
            
            let messageCount;
            let maxMessages;
            let messageCountKey;

            if (isPremium) {
                messageCountKey = MESSAGE_COUNT_KEY_PAID;
                messageCount = loadFromLocalStorage(messageCountKey) || 0;
                maxMessages = MAX_MESSAGES_PAID;
            } else {
                messageCountKey = MESSAGE_COUNT_KEY_FREE;
                messageCount = loadFromLocalStorage(messageCountKey) || 0;
                maxMessages = MAX_MESSAGES_FREE;
            }

            if (messageCount >= maxMessages) {
                if (isPremium) {
                    showModal("Limit správ prekročený", `Dosiahli ste limit ${MAX_MESSAGES_PAID} správ. Vaše predplatné bolo vyčerpané. Pre ďalšie používanie je potrebné predplatné obnoviť.`);
                } else {
                    showModal("Limit správ prekročený", `Dosiahli ste limit ${MAX_MESSAGES_FREE} správ pre skúšobnú verziu. Pre neobmedzený prístup je potrebné zaplatiť predplatné.`);
                }
                return;
            }

            // Očistenie a zobrazenie správy od používateľa
            userInput.value = '';
            appendUserMessage(message);

            // Zobrazenie indikátora načítania
            showLoadingIndicator();

            try {
                // Generovanie odpovede AI
                const aiResponse = await generateText(message);
                
                // Zobrazenie odpovede AI
                hideLoadingIndicator();
                appendAiMessage(aiResponse, ttsApiToggle.checked);

                // Inkrementácia počítadla správ
                saveToLocalStorage(messageCountKey, messageCount + 1);

                // Aktualizácia stavu limitu správ
                if (isPremium) {
                    messageLimitStatus.innerText = `Platená verzia: ${Math.max(0, MAX_MESSAGES_PAID - (messageCount + 1))} správ zostáva.`;
                } else {
                    messageLimitStatus.innerText = `Skúšobná verzia: ${Math.max(0, MAX_MESSAGES_FREE - (messageCount + 1))} správ zostáva.`;
                }

                // Kontrola a spustenie cool-downu
                messagesSinceCooldown++;
                if (!isPremium && messagesSinceCooldown >= MESSAGES_BEFORE_COOLDOWN) {
                    startCooldown();
                }

            } catch (error) {
                console.error('Chyba pri posielaní správy:', error);
                hideLoadingIndicator();
                appendAiMessage('Prepáčte, vyskytla sa chyba pri komunikácii s AI. Skúste to prosím neskôr.', false);
            }
        }

        // --- Event Listenery ---
        
        payButton.addEventListener('click', simulatePayment);
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMessage();
            }
        });

        // Kontrola predplatného pri načítaní stránky
        window.onload = () => {
            checkSubscription();
        };

    </script>
</body>
</html>














